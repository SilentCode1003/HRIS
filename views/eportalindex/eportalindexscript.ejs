<script>
    $(document).ready(function () {
        let userLocation;
        let employeeid = "<%= employeeid %>";
        let devicein = '';
        let deviceout = '';
        let geofenceChecked = false;
        let logStatusChecked = false;
        let bdaydiv = "";
        let anouncementdiv = "";
        LoadTable();
        LoadBdayFolks();
        GenerateAnouncement();

        console.log('ID', employeeid);

        //#region maps

        const OFFICE_LOCATION_LAT = 14.337945;
        const OFFICE_LOCATION_LNG = 121.060511;

        const map = L.map('map').setView([OFFICE_LOCATION_LAT, OFFICE_LOCATION_LNG], 15);

        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);

        // const officeIcon = L.icon({
        //     iconUrl: './images/img/5L.png',  // Replace with the path to your office icon image
        //     iconSize: [32, 32],
        //     iconAnchor: [16, 32],
        //     popupAnchor: [0, -32],
        // });

        // const officeMarker = L.marker([OFFICE_LOCATION_LAT, OFFICE_LOCATION_LNG], { icon: officeIcon }).addTo(map);
        // officeMarker.bindPopup('Office Location').openPopup();

        // let geofence;
        // $.ajax({
        //     type: "POST",
        //     url: "/geofencesettings/selectgeofence",
        //     data: {
        //         departmentid: departmentid,
        //     },
        //     success: function (result) {
        //         let data = result.data;
        //         $.each(data, (key, item) => {
        //             geofence = +L.circle([item.latitude, item.longitude], {
        //                 color: "red",
        //                 fillColor: "#f03",
        //                 fillOpacity: 0.3,
        //                 radius: item.radius,
        //                 departmentid: item.departmentid,
        //             }).addTo(map);
        //         });
        //         //console.log(radius);
        //     },
        //     error: function (error) { },
        // });

        let geofence;
        $.ajax({
            type: "GET",
            url: "/geofencesettings/load",
            success: function (result) {
                let data = result.data;
                $.each(data, (key, item) => {
                    geofence = +L.circle([item.latitude, item.longitude], {
                        color: "red",
                        fillColor: "#f03",
                        fillOpacity: 0.3,
                        radius: item.radius,
                    }).addTo(map);
                });
            },
            error: function (error) { },
        });


        // const geofence = L.circle([OFFICE_LOCATION_LAT, OFFICE_LOCATION_LNG], {
        //     color: 'red',
        //     fillColor: '#f03',
        //     fillOpacity: 0.3,
        //     radius: 100
        // }).addTo(map);

        function checkGeofence(userLocation) {
            const userLatLng = L.latLng(userLocation.lat, userLocation.lng);
            const isInside = userLatLng.distanceTo(geofence.getLatLng()) <= geofence.getRadius();
            //console.log('User is inside the geofence:', isInside);
            return isInside;
        }

        function updateLocationOnMap(position) {
            userLocation = {
                lat: position.coords.latitude,
                lng: position.coords.longitude
            };

            // Clear previous markers
            map.eachLayer((layer) => {
                if (layer instanceof L.Marker) {
                    layer.remove();
                }
            });

            const userMarker = L.marker([userLocation.lat, userLocation.lng]).addTo(map);
            userMarker.bindPopup(`My Location`).openPopup();

            const geofenceButton = document.getElementById('clockinbtn');
            if (checkGeofence(userLocation)) {
                // console.log('User is inside the geofence.');
                geofenceButton.style.display = 'block';
            } else {
                //console.log('User is outside the geofence.');
                geofenceButton.style.display = 'block';
            }
        }

        function handleError(error) {
            console.error(`Error getting user location: ${error.message}`, error);

            if (error.code === error.PERMISSION_DENIED) {
                notifyUserToEnableLocation();
            }
        }

        function notifyUserToEnableLocation() {
            if ('Notification' in window) {
                if (Notification.permission !== 'denied') {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            new Notification('Enable Location Services', {
                                body: 'Please enable location services to use this feature.',
                            });
                        }
                    });
                }
            }
        }

        const watchId = navigator.geolocation.watchPosition(
            updateLocationOnMap,
            handleError,
            {
                enableHighAccuracy: true,
                maximumAge: 30000,
                timeout: 27000
            }
        );

        function updateClockButtonStatus() {
            $.ajax({
                type: "GET",
                url: "/eportalindex/latestlog",
                data: {
                    employeeid: employeeid,
                },
                success: function (response) {

                    if (response && response.al_logtype) {
                        const isClockIn = response.al_logtype === "ClockIn";

                        $('#clockinbtn').toggle(!isClockIn);
                        $('#clockoutbtn').toggle(isClockIn);
                    } else {
                        $('#clockinbtn').show();
                        $('#clockoutbtn').hide();
                    }
                },
                error: function (xhr, status, error) {
                }
            });
        }

        updateClockButtonStatus();


        //#endregion


        //#region clockin/out api




        $('#clockinbtn').on('click', function () {
            // Use SweetAlert to confirm before proceeding with clock-in
            swal({
                title: "Confirm Clock-in",
                text: "Are you sure you want to clock in?",
                icon: "info",
                buttons: ["Cancel", "Yes, Clock In"],
                dangerMode: false,
            }).then((proceed) => {
                if (proceed) {
                    // User clicked "Yes, Clock In"
                    getDeviceInformation()
                        .then((devicein) => {
                            // Use the retrieved devicein value in your AJAX request
                            $.ajax({
                                type: "POST",
                                url: "/eportalindex/clockin",
                                data: {
                                    employeeid: employeeid,
                                    latitude: userLocation.lat,
                                    longitude: userLocation.lng,
                                    employeeid: employeeid,
                                    devicein: devicein,
                                },
                                success: function (response) {

                                    if (response.msg === "exist") {
                                        swal({
                                            title: "Clock-in Warning",
                                            text: "You have already clocked in today.",
                                            icon: "warning",
                                        });
                                    } else if (response.status === "success") {
                                        swal({
                                            title: "Clock-in successful!",
                                            icon: "success",
                                        }).then(() => {
                                            // Handle success
                                        });
                                    } else {
                                        swal({
                                            title: "Clock-in failed",
                                            text: response.message,
                                            icon: "error",
                                        });
                                    }
                                },
                                error: function (xhr, status, error) {

                                    swal({
                                        title: "Error",
                                        text: "Unable to clock in. Please try again.",
                                        icon: "error",
                                    });
                                }
                            });
                        })
                        .catch((error) => {
                            console.error("Error getting device information:", error);
                            // Handle error getting device information
                        });
                } else {
                    // User clicked "Cancel" or closed the modal
                    swal("Clock-in Canceled", "", "info");
                }
            });
        });


        $('#clockoutbtn').on('click', function () {
            if (!userLocation || typeof userLocation.lat === 'undefined' || typeof userLocation.lng === 'undefined') {
                console.error("Error: userLocation is not defined or incomplete.");
                return;
            }

            // Use SweetAlert to confirm before proceeding with clock-out
            swal({
                title: "Confirm Clock-out",
                text: "Are you sure you want to clock out?",
                icon: "info",
                buttons: ["Cancel", "Yes, Clock Out"],
                dangerMode: false,
            }).then((proceed) => {
                if (proceed) {
                    // User clicked "Yes, Clock Out"
                    $.ajax({
                        type: "POST",
                        url: "/eportalindex/clockout",
                        data: {
                            employeeid: employeeid,
                            latitude: userLocation.lat,
                            longitude: userLocation.lng,
                            employeeid: employeeid,
                            deviceout: deviceout,
                        },

                        success: function (response) {

                            if (response.msg === "success") {
                                swal({
                                    title: "Clock-out successful!",
                                    icon: "success",
                                }).then(() => {
                                    // Handle success
                                });
                            } else if (response.msg === "exist") {
                                swal({
                                    title: "Clock-out failed",
                                    text: "Clock-out not allowed. Employee already clocked out on the same day.",
                                    icon: "error",
                                });
                            } else {
                                swal({
                                    title: "Clock-out failed",
                                    text: response.message || "Unknown error",
                                    icon: "error",
                                });
                            }
                        },
                        error: function (xhr, status, error) {


                            swal({
                                title: "Error",
                                text: "Unable to clock out. Please try again.",
                                icon: "error",
                            });
                        }
                    });
                } else {
                    swal("Clock-out Canceled", "", "info");
                }
            });
        });


        //#endregion


        //#region load employee dashboard


        function LoadTable() {
            $("#attendanceTable").DataTable({
                destroy: true,
                processing: true,
                serverSide: true,
                paging: false,
                searching: false,
                info: false,
                scrollY: 400,
                scrollCollapse: true,
                serverMethod: "POST",
                ajax: {
                    url: "/eportalindex/emplogs",
                    data: {
                        employeeid: employeeid,
                    },
                    dataSrc: (json) => {
                        var finalData = [];
                        var data = json.data;
                        $.each(data, (key, item) => {

                            finalData.push({
                                logdate: item.logdate,
                                logtype: item.logtype,
                                logtime: item.logtime,
                            });
                        });

                        return finalData;
                    },
                },
                columnDefs: [
                    {
                        targets: 1,
                        className: "td-indent",
                    },
                ],
                columns: [
                    { data: "logdate" },
                    { data: "logtype" },
                    { data: "logtime" },
                ],
                createdRow: function (row, data, dataIndex) {
                    $('td', row).each(function (index) {
                        this.style.textAlign = "center";
                        this.style.verticalAlign = "middle";
                    });
                },
                initComplete: function () {
                },
            });
        }


        function LoadBdayFolks() {
            $.ajax({
                type: "GET",
                url: "/getbdaytoday",
                success: function (result) {
                    if (result.msg === "success") {
                        const bdayData = result.data;
                        let counterbday = 0;
                        let bdaydiv = "";

                        if (bdayData.length === 0) {
                            bdaydiv = `<div class="carousel-item active" data-bs-interval="2000">
                                    <img src="/images/img/bday.jpg" class="d-block w-100" alt="Default Image"
                                        style="height: 470px;">
                                    <div class="carousel-caption d-none d-md-block">
                                        <h5>No Birthdays Today</h5>
                                    </div>
                                </div>`;
                        } else {
                            $.each(bdayData, (key, item) => {
                                counterbday++;
                                bdaydiv += `
                            <div class="carousel-item active" data-bs-interval="2000">
                                <img id="preview${counterbday}" src="data:image/jpg;base64,${item.profilePicturePath}" class="d-block w-100" alt="..."
                                    style="height: 470px;">
                                <div class="carousel-caption d-none d-md-block">
                                    <h5 id="employeeid${counterbday}">${item.firstname}</h5>
                                    <h6 id="bdaydate${counterbday}">${item.birthday}</h6>
                                </div>
                            </div>
                            <button class="carousel-control-prev" type="button"
                                data-bs-target="#carouselannouncement" data-bs-slide="prev">
                                <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Previous</span>
                            </button>
                            <button class="carousel-control-next" type="button"
                                data-bs-target="#carouselannouncement" data-bs-slide="next">
                                <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                <span class="visually-hidden">Next</span>
                            </button>`;
                            });
                        }

                        $("#carouselbday").html(bdaydiv);
                    } else {
                        console.error("Error: ", result.message);
                        swal(
                            "An error occurred while fetching announcement data",
                            "Please try again later.",
                            "error"
                        );
                    }
                },
            });
        }




        function GenerateAnouncement() {
            $.ajax({
                type: "GET",
                url: "/getbulletin",
                // data: {
                //   bulletinid: id,
                // },
                success: function (result) {
                    if (result.msg === "success") {
                        const announcementData = result.data;
                        let counter = 0;
                        $.each(announcementData, (key, item) => {
                            counter++;
                            anouncementdiv += `
              <div class="carousel-item active" data-bs-interval="2000">
                <img id="preview${counter}"  src="data:image/jpg;base64,${item.image}" class="d-block w-100" alt="..."
                style="height: 470px;">
              <div class="carousel-caption d-none d-md-block">
                <h5 id="announcetitle${counter}">${item.title}</h5>
                <p id="announcedesc${counter}">${item.description}</p>
                <p id="announcedate${counter}">${item.targetdate}</p>
              </div>
                                    </div>
                                    <button class="carousel-control-prev" type="button"
                                        data-bs-target="#carouselannouncement" data-bs-slide="prev">
                                        <span class="carousel-control-prev-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Previous</span>
                                    </button>
                                    <button class="carousel-control-next" type="button"
                                        data-bs-target="#carouselannouncement" data-bs-slide="next">
                                        <span class="carousel-control-next-icon" aria-hidden="true"></span>
                                        <span class="visually-hidden">Next</span>
                                    </button>`;
                        });
                    } else {
                        console.error("Error: ", result.message);
                        swal(
                            "An error occurred while fetching announcement data",
                            "Please try again later.",
                            "error"
                        );
                    }

                    $("#carouselannouncement").html(anouncementdiv);
                },
                error: function (err) {
                    console.error("AJAX Error: ", err.responseText);
                    swal(
                        "An error occurred while fetching announcement data",
                        "Please try again later.",
                        "error"
                    );
                },
            });
        }

        //#region 

    });
</script>