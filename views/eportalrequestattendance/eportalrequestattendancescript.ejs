<script>
    let leaveid = '';
    $(document).ready(function () {
        console.log('Initialize');
        let employeeid = "<%= employeeid %>";
        LoadTable();

        function LoadTable() {
            $("#dataTablereqCOA").DataTable({
                destroy: true,
                processing: true,
                serverSide: true,
                paging: false,
                searching: false,
                info: false,
                scrollY: 400,
                scrollCollapse: true,
                type: "GET",
                ajax: {
                    url: "/eportalrequestattendance/load",
                    dataSrc: (json) => {
                        var finalData = [];
                        var data = json.data;

                        console.log(data);
                        $.each(data, (key, item) => {
                            var action = "";
                            var status = item.status;

                            action = `
                      <button id="editBtn" class="btn text-primary" name="editBtn" data-bs-toggle="modal" data-bs-target="#allleavemodal"><i class="fas fa-fw fa-pen"></i></button>
                    `;

                            finalData.push({
                                requestid: item.requestid,
                                attendancedate: item.attendancedate,
                                timein: item.timein,
                                timeout: item.timeout,
                                total: item.total,
                                reason: item.reason,
                                requeststatus: item.requeststatus,
                                createdate: item.createdate,
                                action: action,
                            });
                        });

                        console.log(finalData);

                        return finalData;
                    },

                },
                columnDefs: [
                    {
                        targets: 1,
                        className: "td-indent",
                    },
                ],
                columns: [
                    { data: "requestid" },
                    { data: "attendancedate" },
                    { data: "timein" },
                    { data: "timeout" },
                    { data: "total" },
                    { data: "reason" },
                    { data: "requeststatus" },
                    { data: "createdate" },
                    { data: "action" },
                ],
                initComplete: function () {
                    console.log('Done');
                },
            });
        }

        $(document).on("click", "#coasavebtn", function () {
            let attendancedate = $("#attendancedate").val();
            let timein = $("#timein").val();
            let timeout = $("#timeout").val();
            let reason = $("#coareason").val();

            var message = "";

            if (attendancedate == "") {
                message += "shiftname is required ";
            }

            if (timein == "") {
                message += "status is required ";
            }

            if (timeout == "") {
                message += "department is required ";
            }

            if (reason == "") {
                message += "createby is required ";
            }

            if (message !== "") {
                swal("Validation Error", message, "error");
            } else {
                $.ajax({
                    type: "POST",
                    url: "/eportalrequestattendance/submit",
                    data: {
                        employeeid: employeeid,
                        attendancedate: attendancedate,
                        timein: timein,
                        timeout: timeout,
                        reason: reason,
                    },
                    success: function (result) {
                        if (result.msg == "success") {
                            swal("Update Successfully", "You clicked the button!", "success",)
                                .then(results => {
                                    window.location.reload();
                                });
                            LoadTable();
                        } else if (result.msg == "exist") {
                            swal("Exist", "Data already exists!", "warning",);
                        }
                    },
                    error: function (err) {
                        swal("Error", "An error occurred while saving data.", "error");
                    },
                });

            }

        });

        $("#dataTableapplyleave tbody").on("click", "tr", function () {
            var dataRow = [];
            $(this)
                .closest("tr")
                .find("td")
                .each(function () {
                    dataRow.push($(this).text());
                });
            console.log(dataRow);
            leaveid = dataRow[0];
        });
        $(document).on("click", "#editBtn", function () {
            $.ajax({
                type: "POST",
                url: "/allleave/getleavedashboard",
                data: {
                    leaveid: leaveid,
                },
                success: function (result) {
                    if (result.msg === "success") {
                        const existingData = result.data;

                        $.each(existingData, (key, item) => {
                            $("#id").val(item.leaveid);
                            $("#pendingleavename").val(item.employeeid);
                            $("#pendingleaveemail").val(item.email);
                            $("#pendingleavegender").val(item.gender);
                            $("#pendingleavephone").val(item.phone);
                            $("#pendingleavetype").val(item.leavetype);
                            $("#pendingleaveapplydate").val(item.applieddate);
                            $("#pendingleavestart").val(item.leavestartdate);
                            $("#pendingleaveend").val(item.leaveenddate);
                            $("#pendingleavereason").val(item.reason);
                            $("#pendingleaveaction").val(item.status);
                        });
                    } else {
                        swal("Error fetching employee data", "success");
                    }
                },
                error: function (err) {
                    swal("An error occurred while fetching employee data", err, "error");
                },
            });
        });
        $(document).on("click", "#pendingleavesavebtn", function () {
            console.log("Save button clicked");
            let id = leaveid
            let status = $("#pendingleaveaction").val();

            var message = "";


            if (status === "") {
                message += "status is required. ";
            }




            if (message !== "") {
                swal("Validation Error", message, "error");
            } else {
                $.ajax({
                    type: "POST",
                    url: "/allleave/update",
                    data: {
                        leaveid: id,
                        status: status,
                    },
                    success: function (result) {
                        if (result.msg == "success") {
                            swal("Save Successfully", "You clicked the button!", "success",)
                                .then(results => {
                                    window.location.reload();
                                });
                            LoadTable();
                        }
                    },
                    error: function (err) {
                        swal("Error", "An error occurred while saving data.", "error");
                    },
                    error: function (err) {
                        swal("Error", "An error occurred while saving data.", "error");
                    },
                });
            }
        });

    });

    function submitRequest() {
        var selectedDate = document.getElementById("datepicker").value;
        // Here you can perform further actions like sending the selected date to the server
        console.log("Attendance requested for date:", selectedDate);
        // Close the modal
        $('#attendanceModal').modal('hide');
    }


</script>


<!--- Eportal Topbar & Navbar-->
<script>
    $(document).ready(function () {
        let isSidebarOpen = localStorage.getItem('isSidebarOpen') === 'true';

        function updateSidebarState() {
            $("body").toggleClass("sidebar-toggled", isSidebarOpen);
            $(".sidebar").toggleClass("toggled", isSidebarOpen);

            if (isSidebarOpen) {
                $('.sidebar .collapse').collapse('hide');
                $('#content').toggleClass('content-toggled');
                $('#topbar').toggleClass('topbar-toggled ');
                $('.sticky-footer').toggleClass('footer-toggled');
            } else {
                $('#content').removeClass('content-toggled');
                $('#topbar').removeClass('topbar-toggled ');
                $('.sticky-footer').removeClass('footer-toggled');
            }
        }

        updateSidebarState();

        $("#sidebarToggle, #sidebarToggleTop").on('click', function (e) {
            isSidebarOpen = !isSidebarOpen;

            localStorage.setItem('isSidebarOpen', isSidebarOpen);

            updateSidebarState();
        });
    });

</script>